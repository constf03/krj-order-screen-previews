<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Ravintola Johnny - Tilaus</title>
    <!--Google Fonts-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Rubik:ital,wght@0,300..900;1,300..900&family=UnifrakturMaguntia&display=swap"
      rel="stylesheet"
    />
    <!--Bootstrap CSS-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />
    <!--Custom Styles-->
    <link href="./styles/globals.css" rel="stylesheet" />
    <link href="./styles/colors.css" rel="stylesheet" />
    <link href="./styles/fonts.css" rel="stylesheet" />
    <link href="./styles/screens/screen_order_main.css" rel="stylesheet" />
  </head>
  <body>
    <div class="page">
      <div class="banner mb-4">
        <img src="images/krj_banner.png" alt="..." />
      </div>
      <div class="container-order-screen">
        <div class="container-left">
          <div class="container-menu">
            <button
              class="btn btn-primary btn-menu m-1"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapseExample"
              aria-expanded="false"
              aria-controls="collapseExample"
            >
              Menu
            </button>
            <div class="collapse show" id="collapseExample">
              <div class="card card-body gap-1">
                <button class="btn btn-primary collapsible-item">
                  Alkuruoat
                </button>
                <button class="btn btn-primary collapsible-item">
                  Kana-annokset
                </button>
                <button class="btn btn-primary collapsible-item">Nauta</button>
                <button class="btn btn-primary collapsible-item">Ankka</button>
                <button class="btn btn-primary collapsible-item">
                  Jättirapu
                </button>
                <button class="btn btn-primary collapsible-item">Possu</button>
                <button class="btn btn-primary collapsible-item">Kasvis</button>
              </div>
            </div>
          </div>
          <div class="container-counter">
            <div
              class="container-cart"
              data-bs-toggle="modal"
              data-bs-target="#cartModal"
            >
              <p class="cart-header">Ostoskärry</p>
              <div style="width: 100%">
                <img
                  src="images/shopping_cart.png"
                  style="width: 100%"
                  alt="..."
                />
              </div>
              <div class="container-cart-amount">
                <span id="amount">0</span>
              </div>
            </div>
            <!-- Cart Modal -->
            <div
              class="modal fade"
              id="cartModal"
              tabindex="-1"
              aria-labelledby="cartModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5" id="cartModalLabel">
                      Ostoskärry
                    </h1>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <div id="list-shopping-cart"></div>
                    <div class="mt-8"><span id="cart-total"></span></div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      data-bs-dismiss="modal"
                    >
                      Sulje
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      data-bs-dismiss="modal"
                    >
                      Siirry maksamaan
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div style="display: flex; flex-direction: column">
              <button
                class="btn btn-outline-primary mb-2"
                onclick="window.location.href = './screen_checkout.html'"
              >
                Siirry maksamaan
              </button>
              <button
                class="btn btn-outline-danger"
                data-bs-toggle="modal"
                data-bs-target="#cancelOrderModal"
              >
                Peruuta tilaus
              </button>
              <!-- Cancel Order Modal -->
              <div
                class="modal fade"
                id="cancelOrderModal"
                tabindex="-1"
                aria-labelledby="cancelOrderModalLabel"
                aria-hidden="true"
              >
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="cancelOrderModalLabel">
                        Vahvistus
                      </h1>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      ></button>
                    </div>
                    <div class="modal-body">
                      Haluatko varmasti peruuttaa tilauksesi?
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-outline-danger"
                        data-bs-dismiss="modal"
                      >
                        Ei
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-primary"
                        id="btn-confirm-cancel"
                      >
                        Kyllä
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="container-right">
          <div>
            <h3 class="h3"><b>Kokin valinnat</b></h3>
            <p class="mb-8">
              Voit lisätä tuotteita tilaukseesi koskettamalla niitä.
            </p>
            <div class="container-menu-items" id="chef-selection"></div>
            <!--Add To Cart Modal-->
            <div
              class="modal fade"
              id="addToCartModal"
              tabindex="-1"
              aria-labelledby="addToCartModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5" id="addToCartModalLabel">
                      Lisää tuote ostoskärryyn
                    </h1>
                    <button
                      type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    ></button>
                  </div>
                  <div class="modal-body">
                    <div>
                      <div style="width: 64px">
                        <img
                          src="./images/krj_logo_default.png"
                          style="width: 100%"
                          alt="..."
                        />
                      </div>
                      <div>
                        <p id="modal-itemname"></p>
                        <p id="modal-itemprice"></p>
                      </div>
                    </div>
                    <div>
                      <div>
                        <button
                          class="btn btn-outline-secondary"
                          onclick="handleItemQuantityChange('-')"
                        >
                          -
                        </button>
                        <button
                          class="btn btn-outline-secondary"
                          onclick="handleItemQuantityChange('+')"
                        >
                          +
                        </button>
                        <div>
                          <span id="modal-itemquantity"></span>
                        </div>
                      </div>
                      <div>
                        <span
                          >Yhteensä: <span id="modal-itemtotal"></span
                        ></span>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-outline-danger"
                      data-bs-dismiss="modal"
                    >
                      Peruuta
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      data-bs-dismiss="modal"
                      onclick="addToCart()"
                    >
                      Lisää
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-4">
            <h3 class="h3"><b>Ota itsellesi juotavaa</b></h3>
            <div class="container-menu-items" id="drinks"></div>
          </div>
        </div>
      </div>
    </div>

    <!--Bootstrap JS-->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.min.js"
      integrity="sha384-RuyvpeZCxMJCqVUGFI0Do1mQrods/hhxYlcVfGPOfQtPJh0JCw12tUAZ/Mv10S7D"
      crossorigin="anonymous"
    ></script>

    <!--Embedded JS Code-->
    <script>
      const chefSelection = document.getElementById("chef-selection");
      const drinkSelection = document.getElementById("drinks");
      const modalItemName = document.getElementById("modal-itemname");
      const modalItemPrice = document.getElementById("modal-itemprice");
      const modalItemQuantity = document.getElementById("modal-itemquantity");
      const modalItemTotal = document.getElementById("modal-itemtotal");
      const cartAmount = document.getElementById("amount");
      const confirmCancelBtn = document.getElementById("btn-confirm-cancel");
      const shoppingCart = document.getElementById("list-shopping-cart");
      const cartTotal = document.getElementById("cart-total");
      let quantity = 1;
      let cartItems = [];
      let total = 0;
      let itemId;

      cartTotal.innerHTML = `Yhteensä: ${total} €`;

      const fetchData = async (endpoint) => {
        const response = await fetch(
          `https://api.ravintolajohnny.fi/api/menu/${endpoint}`
        );
        const data = await response.json();
        return data;
      };

      const displayChefSelection = async () => {
        const payload = await fetchData("kokinvalinnat");

        let dataDisplay = payload
          .map((object) => {
            const { id, itemName, itemDescription, itemPrice } = object;

            const menuItem = `
            <div
            class="menu-item"
            data-bs-toggle="modal"
            data-bs-target="#addToCartModal"
            onclick="setAddToCartModalData(${id}, '${itemName}', ${itemPrice})"
            >
              <div class="menu-item-default-logo">
                <img src="./images/krj_logo_default.png" style="width: 100%" alt="..."/>
              </div>
              <div class="menu-item-info">
                <p>${itemName}</p>
                <p>${itemDescription ? itemDescription : ""}</p>
              </div>
              <div class="menu-item-price-tag">
                <span>${itemPrice} €</span>
              </div>
            </div>
          `;

            switch (itemName) {
              case "Tulivuori Kana":
              case "Paistettua Kiinalaista Nuudelia (Nauta)":
              case "Japanilaiset Nuudelit (Kana)":
              case "Kung Po Ankka":
              case "Satay Jättirapu":
              case "Kevätrullat (10 kpl)":
                return menuItem;
                break;
              default:
                break;
            }
          })
          .join("");

        chefSelection.innerHTML = dataDisplay;
      };

      displayChefSelection();

      const displayDrinks = async () => {
        const payload = await fetchData("juomat");

        let dataDisplay = payload
          .map((object) => {
            const { itemName, itemPrice } = object;

            const createDrink = (imgSrc) => {
              return `
            <div class="menu-item">
              <div style="width: 40px; margin: 6px;">
                <img src=${imgSrc} style="width: 100%" alt="..."/>
              </div>
              <div>
                <p>${itemName}</p>
              </div>
              <div class="menu-item-price-tag">
                ${itemPrice} €
              </div>
            </div>
          `;
            };

            switch (itemName) {
              case "Coca Cola (0,33 l)":
                return createDrink("./images/coke_033l.png");
                break;
              case "Coca Cola (1,5 l)":
                return createDrink("./images/coke_15l.png");
                break;
              default:
                break;
            }
          })
          .join("");

        drinkSelection.innerHTML = dataDisplay;
      };

      displayDrinks();

      confirmCancelBtn.addEventListener("click", () => {
        cancelOrder();
      });

      const setAddToCartModalData = (id, name, price, imgSrc) => {
        itemId = id;
        modalItemName.innerHTML = name;
        modalItemPrice.innerHTML = `${price} €`;
        modalItemQuantity.innerHTML = quantity;
        modalItemTotal.innerHTML = `${price * modalItemQuantity.innerHTML} €`;
      };

      const handleItemQuantityChange = (operation) => {
        if (operation === "+") {
          if (quantity > 9 || modalItemName.innerHTML.includes("Kevätrullat"))
            return;
          quantity++;
          modalItemQuantity.innerHTML = quantity;
          modalItemTotal.innerHTML = `${
            parseInt(modalItemPrice.innerHTML) *
            parseInt(modalItemQuantity.innerHTML)
          } €`;
        }

        if (operation === "-") {
          if (quantity <= 1 || modalItemName.innerHTML.includes("Kevätrullat"))
            return;
          quantity--;
          modalItemQuantity.innerHTML = quantity;
          modalItemTotal.innerHTML = `${
            parseInt(modalItemPrice.innerHTML) *
            parseInt(modalItemQuantity.innerHTML)
          } €`;
        }
      };

      const addToCart = () => {
        const newItem = {
          id: itemId,
          name: modalItemName.innerHTML,
          price: parseInt(modalItemPrice.innerHTML),
          quantity: parseInt(modalItemQuantity.innerHTML),
          total: parseInt(modalItemTotal.innerHTML),
        };

        for (let i = 0; i < cartItems.length; i++) {
          if (cartItems[i].id === newItem.id) {
            console.log("Item already exists in cart");
            return;
          }
        }

        cartItems.push(newItem);
        console.log("Shopping Cart", cartItems);
        cartAmount.innerHTML = getCartAmount();
        localStorage.setItem("CartItems", JSON.stringify(cartItems));
        updateShoppingCartData();
        quantity = 1;
        console.log(JSON.parse(localStorage.getItem("CartItems")));
      };

      const getCartAmount = () => {
        let amount = 0;

        cartItems.forEach((object) => {
          amount += object.quantity;
        });

        return amount;
      };

      const updateShoppingCartData = () => {
        const items = cartItems
          .map((object) => {
            const { name, price, quantity, total } = object;

            return `
            <div class="container-cart-item">
              <div class="wrapper-cart-item">
                <div class="item-content-left">
                  <span>${name}</span>
                  <div>
                    <span class="badge text-bg-secondary">${quantity}</span>
                    <button class="btn btn-outline-primary">+</button>
                    <button class="btn btn-outline-primary">-</button>
                    <button class="btn btn-outline-danger">X</button>
                  </div>
                </div>
                <span class="pricetag-cart-item">${total} €</span>
              </div>
            </div>
          `;
          })
          .join("");

        total = 0;
        cartItems.forEach((object) => {
          total += object.total;
        });

        shoppingCart.innerHTML = items;
        cartTotal.innerHTML = `Yhteensä: ${total} €`;
        localStorage.setItem("CartTotal", total.toString());
      };

      const cancelOrder = () => {
        localStorage.setItem("CartItems", JSON.stringify([]));
        localStorage.setItem("CartTotal", "0");
        window.location.href = "./index.html";
      };

      const loadCart = () => {
        const savedItems = JSON.parse(localStorage.getItem("CartItems"));
        if (savedItems.length > 0) {
          cartItems = savedItems;
          updateShoppingCartData();
          cartAmount.innerHTML = getCartAmount();
        }
      };

      loadCart();
    </script>
  </body>
</html>
